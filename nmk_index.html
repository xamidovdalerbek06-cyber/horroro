<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SIGNAL LOSS - Mobile Edition</title>
    <style>
        body { margin: 0; padding: 0; overflow: hidden; background: #000; font-family: monospace; user-select: none; touch-action: none; }
        #canvas { display: block; width: 100vw; height: 100vh; }
        
        /* UI Overlay */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        
        /* Joystick */
        #joystick-base { 
            position: absolute; bottom: 40px; left: 40px; 
            width: 120px; height: 120px; background: rgba(255,255,255,0.1); 
            border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; pointer-events: auto;
        }
        #joystick-knob { 
            position: absolute; top: 35px; left: 35px; 
            width: 50px; height: 50px; background: rgba(255,255,255,0.5); border-radius: 50%; 
        }

        /* Buttons */
        .btn { 
            position: absolute; width: 60px; height: 60px; 
            background: rgba(255,255,255,0.1); border: 1px solid #fff; 
            color: white; display: flex; align-items: center; justify-content: center; 
            font-size: 10px; border-radius: 10px; pointer-events: auto;
        }
        #btn-light { bottom: 120px; right: 30px; }
        #btn-sprint { bottom: 40px; right: 30px; background: rgba(255,0,0,0.1); }
        #btn-radio { bottom: 200px; right: 30px; }

        /* HUD */
        #hud { position: absolute; top: 20px; left: 20px; color: #fff; text-shadow: 1px 1px #000; }
        #radio-msg { position: absolute; top: 20px; right: 20px; color: #0f0; text-align: right; font-size: 12px; width: 150px; }
        #battery-bar { width: 100px; height: 5px; background: #333; margin-top: 5px; }
        #battery-fill { height: 100%; background: #0f0; width: 100%; }

        #start-screen {
            position: absolute; width: 100%; height: 100%; background: #000;
            color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100;
        }
    </style>
</head>
<body>

    <div id="start-screen" onclick="init()">
        <h1 style="letter-spacing: 10px;">SIGNAL LOSS</h1>
        <p>MOBILE INSPECTION UNIT</p>
        <div style="border: 2px solid #fff; padding: 20px; margin: 20px;">[ TAP TO START ]</div>
    </div>

    <canvas id="canvas"></canvas>

    <div id="ui-layer">
        <div id="joystick-base"><div id="joystick-knob"></div></div>
        
        <div id="btn-light" class="btn" onclick="toggleLight()">LIGHT</div>
        <div id="btn-radio" class="btn" onclick="toggleRadio()">RADIO</div>
        <div id="btn-sprint" class="btn">SPRINT</div>

        <div id="hud">
            TORCH POWER
            <div id="battery-bar"><div id="battery-fill"></div></div>
            <div id="awareness" style="font-size: 9px; margin-top: 10px; color: #555;">SIGNAL STABILITY: 100%</div>
        </div>

        <div id="radio-msg"></div>
    </div>

    <script>
        const canvas = document.getElementById("canvas");
        const ctx = canvas.getContext("2d");

        // --- WORLD DATA ---
        const worldMap = [
            [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
            [1,0,0,0,0,0,1,0,0,0,0,0,0,0,1],
            [1,0,2,0,0,0,3,0,0,0,0,2,0,0,1],
            [1,0,0,0,0,0,1,0,0,0,0,0,0,0,1],
            [1,1,1,3,1,1,1,0,0,2,0,0,0,0,1],
            [1,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
            [1,0,0,2,0,0,0,0,0,0,0,2,0,0,1],
            [1,1,1,0,1,1,1,1,3,1,1,1,1,1,1],
            [1,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
            [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
        ];

        // --- STATE ---
        let posX = 1.5, posY = 1.5, dirX = 1, dirY = 0, planeX = 0, planeY = 0.66, pitch = 0;
        let battery = 100, flashlightOn = true, radioOn = true, awareness = 0;
        let isStarted = false, isSprinting = false;
        
        // --- TOUCH CONTROLS ---
        let joyActive = false, joyX = 0, joyY = 0;
        let lookTouchId = null, lastLookX = 0, lastLookY = 0;

        function init() {
            document.getElementById("start-screen").style.display = "none";
            isStarted = true;
            resize();
            loop();
        }

        // --- JOYSTICK LOGIC ---
        const joyBase = document.getElementById("joystick-base");
        const joyKnob = document.getElementById("joystick-knob");

        joyBase.addEventListener("touchstart", (e) => { joyActive = true; handleJoy(e); }, {passive: false});
        window.addEventListener("touchmove", (e) => { if(joyActive) handleJoy(e); handleLook(e); }, {passive: false});
        window.addEventListener("touchend", (e) => { 
            for(let i=0; i<e.changedTouches.length; i++) {
                if(e.changedTouches[i].target === joyBase) { joyActive = false; joyX = 0; joyY = 0; joyKnob.style.transform = `translate(0,0)`; }
                if(e.changedTouches[i].identifier === lookTouchId) lookTouchId = null;
            }
        }, {passive: false});

        function handleJoy(e) {
            let touch = Array.from(e.touches).find(t => t.target === joyBase);
            if(!touch) return;
            const rect = joyBase.getBoundingClientRect();
            const centerX = rect.left + rect.width/2;
            const centerY = rect.top + rect.height/2;
            let dx = touch.clientX - centerX;
            let dy = touch.clientY - centerY;
            const dist = Math.min(60, Math.sqrt(dx*dx + dy*dy));
            const angle = Math.atan2(dy, dx);
            joyX = (Math.cos(angle) * dist) / 60;
            joyY = (Math.sin(angle) * dist) / 60;
            joyKnob.style.transform = `translate(${joyX * 40}px, ${joyY * 40}px)`;
        }

        function handleLook(e) {
            let touch = Array.from(e.touches).find(t => t.clientX > window.innerWidth/2);
            if(!touch) return;
            if(lookTouchId === null) {
                lookTouchId = touch.identifier;
                lastLookX = touch.clientX;
                lastLookY = touch.clientY;
            } else if (touch.identifier === lookTouchId) {
                let dx = touch.clientX - lastLookX;
                let dy = touch.clientY - lastLookY;
                
                // Yaw
                let rotSpeed = dx * -0.005;
                let oldDirX = dirX;
                dirX = dirX * Math.cos(rotSpeed) - dirY * Math.sin(rotSpeed);
                dirY = oldDirX * Math.sin(rotSpeed) + dirY * Math.cos(rotSpeed);
                let oldPlaneX = planeX;
                planeX = planeX * Math.cos(rotSpeed) - planeY * Math.sin(rotSpeed);
                planeY = oldPlaneX * Math.sin(rotSpeed) + planeY * Math.cos(rotSpeed);

                // Pitch
                pitch -= dy * 2;
                pitch = Math.max(-400, Math.min(400, pitch));

                lastLookX = touch.clientX;
                lastLookY = touch.clientY;
            }
        }

        // --- BUTTONS ---
        const btnSprint = document.getElementById("btn-sprint");
        btnSprint.addEventListener("touchstart", () => isSprinting = true);
        btnSprint.addEventListener("touchend", () => isSprinting = false);

        function toggleLight() { if(battery > 0) flashlightOn = !flashlightOn; }
        function toggleRadio() { radioOn = !radioOn; }
        
        window.addEventListener("click", (e) => {
            if(e.target.id === "canvas") {
                let cx = Math.floor(posX + dirX * 0.7);
                let cy = Math.floor(posY + dirY * 0.7);
                if(worldMap[cx] && worldMap[cx][cy] === 3) worldMap[cx][cy] = 0;
            }
        });

        // --- ENGINE ---
        function update() {
            const moveSpeed = (isSprinting ? 0.09 : 0.05);
            
            // Forward/Back (joyY)
            if(joyY !== 0) {
                let nx = posX - dirX * joyY * moveSpeed;
                let ny = posY - dirY * joyY * moveSpeed;
                if(worldMap[Math.floor(nx)][Math.floor(posY)] === 0) posX = nx;
                if(worldMap[Math.floor(posX)][Math.floor(ny)] === 0) posY = ny;
            }
            // Strafe L/R (joyX)
            if(joyX !== 0) {
                let nx = posX + dirY * joyX * moveSpeed;
                let ny = posY - dirX * joyX * moveSpeed;
                if(worldMap[Math.floor(nx)][Math.floor(posY)] === 0) posX = nx;
                if(worldMap[Math.floor(posX)][Math.floor(ny)] === 0) posY = ny;
            }

            // Awareness & Battery
            if(flashlightOn) { 
                battery -= 0.02; 
                awareness += 0.01; 
                if(battery <= 0) { battery = 0; flashlightOn = false; }
            }
            if(isSprinting && (joyX !== 0 || joyY !== 0)) awareness += 0.08;
            awareness = Math.max(0, Math.min(100, awareness - 0.005));

            document.getElementById("battery-fill").style.width = battery + "%";
            document.getElementById("awareness").innerText = `SIGNAL STABILITY: ${Math.floor(100-awareness)}%`;
            
            const rMsg = document.getElementById("radio-msg");
            if(radioOn) {
                if(awareness > 70) rMsg.innerText = "Control: ...Arthur? ...Something is behind... [STATIC]";
                else rMsg.innerText = "Control: Proceed with inspection.";
            } else { rMsg.innerText = ""; }
        }

        function render() {
            const w = canvas.width, h = canvas.height;
            ctx.fillStyle = "#000"; ctx.fillRect(0,0,w,h);

            // Ceiling/Floor
            if(flashlightOn) {
                ctx.fillStyle = "#080808"; ctx.fillRect(0, 0, w, h/2 + pitch);
                ctx.fillStyle = "#121212"; ctx.fillRect(0, h/2 + pitch, w, h);
            }

            for(let x=0; x<w; x+=2) { // x+=2 for performance on mobile
                let cameraX = 2 * x / w - 1;
                let rDirX = dirX + planeX * cameraX;
                let rDirY = dirY + planeY * cameraX;
                let mX = Math.floor(posX), mY = Math.floor(posY);
                let dDX = Math.abs(1/rDirX), dDY = Math.abs(1/rDirY);
                let sX, sY, sDX, sDY;

                if(rDirX < 0) { sX = -1; sDX = (posX - mX) * dDX; }
                else { sX = 1; sDX = (mX + 1.0 - posX) * dDX; }
                if(rDirY < 0) { sY = -1; sDY = (posY - mY) * dDY; }
                else { sY = 1; sDY = (mY + 1.0 - posY) * dDY; }

                let hit = 0, side = 0;
                while(hit === 0) {
                    if(sDX < sDY) { sDX += dDX; mX += sX; side = 0; }
                    else { sDY += dDY; mY += sY; side = 1; }
                    if(worldMap[mX][mY] > 0) hit = 1;
                }

                let pDist = (side === 0) ? (sDX - dDX) : (sDY - dDY);
                
                // LIGHTING: Total Darkness when Off
                let brightness = 0; 
                if(flashlightOn) {
                    brightness = 0.15; // Ambient
                    let focus = Math.abs(cameraX);
                    if(focus < 0.4) brightness += (1.0 - focus * 2.5) * (1.8 / pDist);
                }

                let lH = Math.floor(h / pDist);
                let dStart = -lH / 2 + h / 2 + pitch;
                let color = [80, 80, 85];
                if(worldMap[mX][mY] === 2) color = [120, 30, 30];
                if(worldMap[mX][mY] === 3) color = [100, 90, 50];
                if(side === 1) brightness *= 0.6;

                ctx.fillStyle = `rgb(${color[0]*brightness},${color[1]*brightness},${color[2]*brightness})`;
                ctx.fillRect(x, dStart, 2, lH);
            }
        }

        function loop() {
            if(isStarted) { update(); render(); }
            requestAnimationFrame(loop);
        }

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        window.addEventListener("resize", resize);
    </script>
</body>
</html>